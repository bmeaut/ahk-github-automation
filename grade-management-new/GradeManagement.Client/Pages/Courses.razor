@page "/courses"
@layout AuthenticatedLayout

@using GradeManagement.Client.Components.NewDialogs
@implements IDisposable
@inject IDialogService DialogService
@inject CrudSnackbarService SnackbarService
@inject SubjectService SubjectService
@inject CourseClient CourseClient
@inject SubjectClient SubjectClient
@inject NavigationManager NavigationManager
@inject IJSRuntime JsRuntime

@attribute [Authorize(Policy = Policy.RequireAdmin)]


<style>
    .clickable-rows .mud-table-body .mud-table-row {
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .clickable-rows .mud-table-body .mud-table-row:hover {
        background-color: rgba(0, 0, 0, 0.1);
    }
</style>

<PageTitle>Courses</PageTitle>

<LoadingComponent @ref="loadingComponentRef" LongTask="@_loading">
    <MudText Typo="Typo.h4" Class="mt-4">Courses</MudText>
    <MudDivider Class="mb-4"/>
    <MudDataGrid T="CourseResponse" Items="_courses" EditMode="DataGridEditMode.Form" ReadOnly="false"
                 CommittedItemChanges="@CommittedItemChanges" RowClick="@RowClickEvent" Class="clickable-rows">
        <Columns>
            <PropertyColumn Property="x => x.Id" Title="Id" Editable="false"/>
            <PropertyColumn Property="x => x.Name" Title="Name"/>
            <PropertyColumn Property="x => x.MoodleClientId" Title="Moodle Client ID"/>
            <TemplateColumn Title="Semester">
                <CellTemplate>
                    @context.Item.Semester.Name
                </CellTemplate>
                <EditTemplate>
                    <SelectSemester @bind-Value="@context.Item.Semester"/>
                </EditTemplate>
            </TemplateColumn>
            <TemplateColumn Title="Language">
                <CellTemplate>
                    @context.Item.Language.Name
                </CellTemplate>
                <EditTemplate>
                    <SelectLanguage @bind-Value="@context.Item.Language"/>
                </EditTemplate>
            </TemplateColumn>
            <TemplateColumn Title="Public Key">
                <CellTemplate>
                    <MudButton Style="background-color: #e1bee7; color: #6a1b9a;" Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.ContentCopy"
                               OnClick="@(() => CopyToClipboard(context.Item.PublicKey))">
                        Copy
                    </MudButton>
                </CellTemplate>
            </TemplateColumn>
            <DataGridActions TItem="CourseResponse" OnEditItem="@StartEditing" OnDeleteItem="@DeleteItem"/>
        </Columns>
    </MudDataGrid>
    <MudFab Style="position:fixed; bottom:50px;right:50px" Color="@Color.Primary" StartIcon="@Icons.Material.Filled.Add"
            OnClick="@OpenDialog"/>
</LoadingComponent>

@code {
    private ICollection<CourseResponse> _courses = new List<CourseResponse>();
    private LoadingComponent loadingComponentRef;

    private void RowClickEvent(DataGridRowClickEventArgs<CourseResponse> args)
    {
        var courseId = args.Item.Id;
        NavigationManager.NavigateTo($"/courses/{courseId}");
    }

    private async Task _loading()
    {
        _courses = await SubjectClient.GetAllCoursesByIdAsync(SubjectService.CurrentSubject.Id);
        StateHasChanged();
    }


    private async Task OpenDialog()
    {
        var dialog = await DialogService.ShowAsync<NewCourseDialog>("Hello");
        var result = await dialog.Result ?? DialogResult.Cancel();
        if (!result.Canceled && result.Data != null)
        {
            var newCourse = result.Data as CourseRequest;
            newCourse.SubjectId = SubjectService.CurrentSubject.Id;
            await CourseClient.CreateAsync(newCourse);
            await _loading();
        }
    }

    private async Task StartEditing(CellContext<CourseResponse?> context)
    {
        await context.Actions.StartEditingItemAsync();
        StateHasChanged();
    }

    private async Task CommittedItemChanges(CourseResponse item)
    {
        CourseRequest courseRequest = new CourseRequest()
        {
            Id = item.Id,
            Language = item.Language,
            MoodleClientId = item.MoodleClientId,
            Name = item.Name,
            Semester = item.Semester,
            SubjectId = item.SubjectId
        };
        await CourseClient.UpdateAsync(courseRequest.Id, courseRequest);
        //StateHasChanged();
        SnackbarService.ShowEditSuccess();
        //await loadingComponentRef.StartLoading();
        _courses = await SubjectClient.GetAllCoursesByIdAsync(SubjectService.CurrentSubject.Id);
    }

    private async Task DeleteItem(CourseResponse item)
    {
        await CourseClient.DeleteAsync(item.Id);
        SnackbarService.ShowDeleteSuccess();
        await loadingComponentRef.StartLoading();
        StateHasChanged();
    }

    private void OnSubjectChanged()
    {
        loadingComponentRef.StartLoading();
    }

    protected override void OnInitialized()
    {
        SubjectService.OnChange += OnSubjectChanged;
    }

    public void Dispose()
    {
        SubjectService.OnChange -= OnSubjectChanged;
    }

    private async Task CopyToClipboard(string publicKey)
    {
        try
        {
            await JsRuntime.InvokeVoidAsync("navigator.clipboard.writeText", publicKey);
            SnackbarService.ShowSuccess("Public key copied to clipboard!");
        }
        catch (JSException)
        {
            await JsRuntime.InvokeVoidAsync("copyTextFallback", publicKey);
            SnackbarService.ShowSuccess("Public key copied to clipboard!");
        }
    }

}
