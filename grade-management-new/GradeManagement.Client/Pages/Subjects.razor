@page "/subjects"
@using GradeManagement.Shared.Dtos.Response
@inject HttpClient Http
@inject IDialogService DialogService
@inject CrudSnackbarService SnackbarService
@inject SubjectService SubjectService

<PageTitle>Subjects</PageTitle>

<LoadingComponent IsLoading="@_isLoading">
    <MudDataGrid Items="_subjects" T="Subject" EditMode="DataGridEditMode.Form" ReadOnly="false" CommittedItemChanges="@CommittedItemChanges">
        <Columns>
            <PropertyColumn Property="x => x.Id" Title="Id" IsEditable="false"/>
            <PropertyColumn Property="x => x.Name" Title="Name"/>
            <PropertyColumn Property="x => x.NeptunCode" Title="Description"/>
            <DataGridActions TItem="Subject" OnEditItem="@StartEditing" OnDeleteItem="@DeleteItem"/>
        </Columns>
    </MudDataGrid>
    <MudFab Style="position:fixed; bottom:50px;right:50px" Color="@Color.Primary" Icon="@Icons.Material.Filled.Add" OnClick="@OpenDialog"/>
</LoadingComponent>

@code {
    private List<Subject> _subjects = new();
    private bool _isLoading = true;

    readonly string BaseUrl = Endpoints.SUBJECTS;

    /*private string[] EditableProperties =
    [
        "Name", "NeptunCode"
    ];*/

    private async Task OpenDialog()
    {
        var dialog = await DialogService.ShowAsync<NewSubjectDialog>("Hello");
        var result = await dialog.Result;
        if (!result.Canceled && result.Data != null)
        {
            _subjects.Add(result.Data as Subject);
            var response = await Http.PostAsJsonAsync(BaseUrl, result.Data);
            if (response.IsSuccessStatusCode)
            {
                Subject newObject = await response.Content.ReadFromJsonAsync<Subject>();
                //Right now it needs Course list to be filled
                _subjects.Remove(result.Data as Subject);
                _subjects.Add(newObject);
                SnackbarService.ShowAddSuccess();
            }
            else
            {
                _subjects.Remove(result.Data as Subject);
                await Console.Error.WriteLineAsync("Error");
                SnackbarService.ShowAddError();
            }
        }
    }

    private async Task StartEditing(CellContext<Subject?> context)
    {
        await context.Actions.StartEditingItemAsync();
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        _subjects = await SubjectService.LoadSubjects();
        _isLoading = false;
    }

    private async Task CommittedItemChanges(Subject items)
    {
        var response = await Http.PutAsJsonAsync($"{BaseUrl}/{items.Id}", items);
        if (!response.IsSuccessStatusCode)
        {
            await Console.Error.WriteLineAsync("Error");
            SnackbarService.ShowEditError();
        }
        else
        {
            SnackbarService.ShowEditSuccess();
        }
    }

    private async Task DeleteItem(Subject item)
    {
        _subjects.Remove(item);
        var response = await Http.DeleteAsync($"{BaseUrl}/{item.Id}");
        if (!response.IsSuccessStatusCode)
        {
            await Console.Error.WriteLineAsync("Error");
            SnackbarService.ShowDeleteError();
        }
        else
        {
            SnackbarService.ShowDeleteSuccess();
        }
        StateHasChanged();
    }

}
